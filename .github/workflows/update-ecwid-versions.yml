name: Update Ecwid Description Versions

on:
  workflow_dispatch:  # Manual trigger for testing
  push:
    branches: [main]
    paths:
      - '**/*.htm'

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Detect changed products
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Push event: detect only changed slugs
            SLUGS=$(git diff --name-only HEAD~1 HEAD | grep '\.htm$' | sed 's|/.*||' | sort -u | tr '\n' ' ')
          else
            # Manual dispatch: scan all product directories
            SLUGS=$(find . -maxdepth 2 -name '*.htm' -not -path './.github/*' | sed 's|^\./||;s|/.*||' | sort -u | tr '\n' ' ')
          fi
          echo "slugs=$SLUGS" >> $GITHUB_OUTPUT
          echo "commit=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "Changed products: $SLUGS"

      - name: Update Ecwid placeholders
        if: steps.changes.outputs.slugs != ''
        env:
          ECWID_STORE_ID: ${{ secrets.ECWID_STORE_ID }}
          ECWID_API_KEY: ${{ secrets.ECWID_API_KEY }}
          COMMIT_HASH: ${{ github.sha }}
        run: |
          STORE_ID="$ECWID_STORE_ID"
          TOKEN="$ECWID_API_KEY"
          API="https://app.ecwid.com/api/v3/$STORE_ID"
          COMMIT="$COMMIT_HASH"

          for SLUG in ${{ steps.changes.outputs.slugs }}; do
            echo "=== Processing: $SLUG ==="
            
            # Lookup product ID from slug-map.json (no unreliable keyword search)
            PRODUCT_ID=$(jq -r --arg slug "$SLUG" '.[$slug] // empty' slug-map.json)
            
            if [ -z "$PRODUCT_ID" ]; then
              echo "  ⚠ No mapping found for slug: $SLUG in slug-map.json"
              continue
            fi
            
            echo "  Found product ID: $PRODUCT_ID"
            
            # Fetch current product
            PRODUCT=$(curl -s -H "Authorization: Bearer $TOKEN" "$API/products/$PRODUCT_ID")
            
            # Build update payload: replace data-version=OLD with data-version=NEW in all languages
            PAYLOAD=$(echo "$PRODUCT" | jq --arg commit "$COMMIT" '
              (.descriptionTranslated // {}) | to_entries | map(
                select(.value != null and .value != "" and (.value | test("data-version=")))
                | .value |= gsub("data-version=[a-f0-9]+"; "data-version=" + $commit)
              ) | from_entries | {descriptionTranslated: .}
            ')
            
            if [ "$PAYLOAD" = '{"descriptionTranslated":{}}' ]; then
              echo "  ⏭ No placeholders found, skipping"
              continue
            fi
            
            # Also update main description field
            MAIN_DESC=$(echo "$PRODUCT" | jq -r --arg commit "$COMMIT" '
              .descriptionTranslated.en // empty
              | gsub("data-version=[a-f0-9]+"; "data-version=" + $commit)
            ')
            
            if [ -n "$MAIN_DESC" ]; then
              PAYLOAD=$(echo "$PAYLOAD" | jq --arg desc "$MAIN_DESC" '. + {description: $desc}')
            fi
            
            echo "  Updating data-version to ${COMMIT:0:12}..."
            echo "  Payload size: $(echo "$PAYLOAD" | wc -c) bytes"
            
            # PUT to Ecwid
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "$API/products/$PRODUCT_ID" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "  ✅ Updated successfully ($(echo "$BODY" | jq -r '.updateCount // "?"') fields)"
            else
              echo "  ❌ Failed ($HTTP_CODE): $BODY"
            fi
          done

      - name: Purge jsDelivr cache
        if: steps.changes.outputs.slugs != ''
        run: |
          for SLUG in ${{ steps.changes.outputs.slugs }}; do
            echo "Purging CDN cache for $SLUG..."
            curl -s "https://purge.jsdelivr.net/gh/DATEx2/products@main/$SLUG/" || true
          done
