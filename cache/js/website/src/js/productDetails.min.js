import V,{svgIcons as Y}from"./translations.js";import O from"@datex2/typewriterjs/dist/core";import{$ as g,setStyle as w,isDev as P,onUnload as U}from"./utils.js";const N="https://cdn.jsdelivr.net/gh/DATEx2/products";function X(t,i){return P()?`/db/dist/${t}`:`${N}@${i}/${t}`}let C=[];const H=1,J=3,_="data-typed";let T=new Set;const L=[];let E=null,W=new Set;function D(t){return t?t.replace(/&amp;/gi,"&").replace(/&lt;/gi,"<").replace(/&gt;/gi,">"):""}function Z(){T.forEach(t=>{if(!t.hasAttribute(_)){const i=t.dataset.originalText;i&&(t.innerHTML=D(i)),w(t,"height, min-height, position, overflow",""),w(t,"visibility","visible",!0)}}),T.clear()}function I(){C.forEach(t=>{try{t.stop()}catch{}}),C=[],Z()}window.addEventListener("resize",I);function G(){L.forEach(t=>t.disconnect()),L.length=0}U(()=>G(),!0);function R(t,i){const r=t.getAttribute("href"),o=Array.from(t.classList).find(s=>s.startsWith("ec-likely__widget--"));if(o){const s=g(i).find(`.${o}`);s.length&&s.attr("href")!==r&&s.attr("href",r)}}function K(t,i){if(!t||!i)return;g(t).find("a").each(function(){R(this,i)});const r=new MutationObserver(o=>{for(const s of o)s.type==="attributes"&&s.attributeName==="href"&&R(s.target,i)});r.observe(t,{attributes:!0,attributeFilter:["href"],subtree:!0}),L.push(r)}let z=!1;async function Q(){if(!z){z=!0;try{const t=await fetch("/api/versions");if(!t.ok)return;const i=await t.json(),r=document.documentElement,o=r.getAttribute("data-css-v"),s=r.getAttribute("data-js-v");if(o&&i.css&&o!==i.css){console.log(`[Versions] CSS update: ${o} \u2192 ${i.css}`);const l=document.getElementById("dxCSS");if(l){const c=document.createElement("link");c.id="dxCSS",c.rel="stylesheet",c.title="dx",c.media="all",c.href=P()?`/db/dist/css/DATEx2.bike.css?v=${i.css}`:l.href.replace(/\?.*$/,"")+`?v=${i.css}`,c.onload=()=>{l.remove(),r.setAttribute("data-css-v",i.css),console.log("[Versions] CSS hot-swapped successfully")},l.parentNode.insertBefore(c,l.nextSibling)}}s&&i.js&&s!==i.js&&(console.log(`[Versions] JS update available: ${s} \u2192 ${i.js}`),tt())}catch(t){console.warn("[Versions] Check failed:",t)}}}function tt(){if(document.getElementById("dx-update-popup"))return;const t=document.createElement("div");t.id="dx-update-popup",t.innerHTML=`
        <div style="position:fixed;inset:0;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)">
            <div style="background:#1a1a2e;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:32px;max-width:400px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.5)">
                <div style="font-size:32px;margin-bottom:12px">\u{1F504}</div>
                <h3 style="color:#fff;font-family:Inter,system-ui,sans-serif;font-size:18px;margin:0 0 8px">New Version Available</h3>
                <p style="color:rgba(255,255,255,.6);font-size:14px;margin:0 0 24px;line-height:1.5">A new version of the app is available. Reload to get the latest features?</p>
                <div style="display:flex;gap:12px;justify-content:center">
                    <button id="dx-update-cancel" style="padding:10px 24px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:transparent;color:rgba(255,255,255,.7);cursor:pointer;font-size:14px;font-family:Inter,system-ui,sans-serif;transition:all .2s">Not Now</button>
                    <button id="dx-update-ok" style="padding:10px 24px;border-radius:10px;border:none;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;cursor:pointer;font-size:14px;font-weight:600;font-family:Inter,system-ui,sans-serif;transition:all .2s">Reload</button>
                </div>
            </div>
        </div>`,document.body.appendChild(t),document.getElementById("dx-update-ok").onclick=()=>{const i=et(),r=new URL(location.href);i&&r.searchParams.set("options",i),location.href=r.toString()},document.getElementById("dx-update-cancel").onclick=()=>t.remove()}function et(){const t=document.querySelectorAll(".form-control");if(!t.length)return"";const i=[];return t.forEach(r=>{const o=r.querySelectorAll("input"),s=r.querySelector("input:checked");s&&o.length?i.push(Array.from(o).indexOf(s)):i.push(0)}),i.join(",")}function it(){const t=new URL(location.href),i=t.searchParams.get("options");if(!i)return;const r=i.split(",").map(Number),o=(s=0)=>{const l=document.querySelectorAll(".form-control");if(!l.length&&s<20){setTimeout(()=>o(s+1),300);return}l.forEach((c,u)=>{if(u<r.length){const n=c.querySelectorAll("input")[r[u]];n&&!n.checked&&n.click()}}),t.searchParams.delete("options"),history.replaceState(null,"",t.toString()),console.log(`[Options] Restored selections: ${i}`)};o()}it();function st(t){const i=g(t);i.arrive(".product-details__product-description",{existing:!0,onceOnly:!1},async e=>{const a=e.querySelector("#pd")||(e.id==="pd"?e:null);if(!a)return;const p=a.getAttribute("data-src"),$=a.getAttribute("data-version");if(!p)return;if(a.innerHTML='<div class="pd-skeleton" style="min-height:400px;background:linear-gradient(90deg,rgba(255,255,255,.03) 25%,rgba(255,255,255,.06) 50%,rgba(255,255,255,.03) 75%);background-size:200% 100%;animation:pd-shimmer 1.5s infinite;border-radius:12px"></div>',!document.getElementById("pd-skeleton-style")){const m=document.createElement("style");m.id="pd-skeleton-style",m.textContent="@keyframes pd-shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}",document.head.appendChild(m)}const y=X(p,$);Q();try{const m=await fetch(y);if(!m.ok){console.warn(`[PD] Failed to load description ${p}: ${m.status}`),a.innerHTML="";return}const h=await m.text();a.outerHTML=h,console.log(`[PD] Injected ${p} (${h.length} chars)`)}catch(m){console.error(`[PD] Fetch error for ${p}:`,m),a.innerHTML=""}});const r={features:"Features",options:"Options",specs:"Specs",reviews:"Reviews"},o=i.findOrCreate(".js-tabs-nav",()=>{const e=g("<div class=js-tabs-nav></div>");for(const[a,p]of Object.entries(r))e.append(`<button class="js-tab-btn" data-tab="${a}">${V(p)}</button>`);return e.append("<div class=share-tabs></div>"),e},!0);i.parent().arrive(".product-details__sidebar .product-details__product-share",{existing:!0,onceOnly:!0},e=>{const a=o.find(".share-tabs");if(a.children().length===0){const p=g(e).clone();a.append(p),a.find(".ec-likely__wrapper").findOrCreate(".ec-likely__widget--whatsapp",()=>`<a href="https://api.whatsapp.com/send/?text=Check%20out%20this%20item%20${encodeURI(location.href)}" target="_blank" class="ec-likely__widget ec-likely__widget--whatsapp"><span class="ec-likely__icon ec-likely__icon--whatsapp">${Y.whatsapp()}</span><span class="ec-likely__button">Share</span></a>`),K(e,p[0])}g(e).hide()});const s={};let l="";function c(e,a=!1){if(i.attr("data-active-tab",e),$d.alterClass("view-tab-*",`view-tab-${e}`),a){const $=e==="options"?window.location.pathname+window.location.search:"#"+e;if(location.hash!==$)try{const y=document.createElement("iframe");y.style.display="none",document.body.appendChild(y),y.contentWindow.history.pushState.call(window.history,null,null,$),document.body.removeChild(y)}catch{history.pushState(null,null,$)}}if(l===e)return;g("body").removeClass(($,y)=>(y.match(/(^|\s)active-tab-\S+/g)||[]).join(" ")),g("body").addClass("active-tab-"+e),s[l]=g("body").scrollTop(),g(".js-tab-btn").removeClass("active"),g(`.js-tab-btn[data-tab="${e}"]`).addClass("active"),l=e;const p=s[e]??0;g("body").stop().animate({scrollTop:p},250),I(),determineProductDetailsLargeOptions(),setTimeout(b,100)}g(".js-tab-btn").on("click",function(){c(g(this).data("tab"),!0)});function u(e){const a=location.hash.replace("#",""),p=a===""?"options":a;return r[p]?(c(p,!1),!0):!1}window.__datex2RouterFilterAttached||(window.__datex2RouterFilterAttached=!0,window.addEventListener("popstate",u,!0,!0),window.addEventListener("hashchange",u,!0,!0)),B();const f=location.hash.replace("#",""),n=r[f]?f:"options";c(n,!1);function d(e){const a=g(e).closest(".product-details"),p=e,$=a.find(".product-details__subtitle .product-details-module__content")[0],y=a.find(".product-details__subtitle-note")[0];[{el:p,speed:J},{el:$,speed:H},{el:y,speed:H}].filter(h=>h.el&&!h.el.hasAttribute(_)).forEach(h=>{h.el.dataset.originalText||(h.el.dataset.originalText=h.el.innerHTML);const k=D(h.el.dataset.originalText),A=g(h.el);w(h.el,"height, min-height",A.outerHeight()+"px",!0),w(h.el,"overflow","hidden",!0),A.empty(),T.add(h.el),w(h.el,{visibility:"visible",opacity:"1"},null,!0);const x=new O(h.el,{loop:!1,delay:1,speed:h.speed,cursor:""});C.push(x),x.typeString(k).callFunction(()=>{h.el.classList.add("anim-active"),h.el.setAttribute(_,"true"),w(h.el,"height, min-height, position, overflow",""),T.delete(h.el)}).start()})}function v(e){if(e.hasAttribute(_))return;if(g(e).is("h1")&&l==="options"){d(e);return}if(g(e).hasClass("details-product-attribute__value")){w(e,{visibility:"visible",opacity:"1"},null,!0),g(e).find(".s1, .s2, .spec-full").each(function(){v(this)});return}const a=e.dataset.originalText||e.innerHTML;e.dataset.originalText||(e.dataset.originalText=a);const p=g(e);w(e,"height, min-height",p.outerHeight()+"px",!0),w(e,"overflow","hidden",!0),p.empty(),T.add(e),w(e,{visibility:"visible",opacity:"1",display:""},null,!0);const y=p.is(".s1, .s2, .spec-full, .details-product-attribute__title")?20:H,m=new O(e,{loop:!1,delay:y,cursor:""});C.push(m);const h=document.createElement("div");h.innerHTML=a;function k(A){Array.from(A).forEach(x=>{if(x.nodeType===3){const S=x.textContent;S.length>0&&m.typeString(S)}else if(x.nodeType===1){const S=x.tagName.toLowerCase();if(["br","img","hr","input"].includes(S)){m.pasteString(x.outerHTML);return}const q=Array.from(x.attributes).map(M=>` ${M.name}="${M.value}"`).join("");m.pasteString(`<${S}${q}>`),k(x.childNodes),m.pasteString(`</${S}>`)}})}k(h.childNodes),m.callFunction(()=>{e.classList.add("anim-active"),e.setAttribute(_,"true"),w(e,"height, min-height, position, overflow",""),T.delete(e)}).start()}function b(){E&&E.disconnect(),W.clear(),E=new IntersectionObserver(a=>{window.requestAnimationFrame(()=>{for(const p of a)p.isIntersecting&&!p.target.hasAttribute(_)&&v(p.target)})},{threshold:.1});const e=["h1","h2","h3","h4","p","li",".product-details-module__title",".review-block__title",".details-product-attribute__title",".s1",".s2",".spec-full",".details-product-attribute__value"].join(", ");i.arrive(e,{existing:!0},function(){this.dataset.originalText||(this.dataset.originalText=this.innerHTML),this.hasAttribute(_)||(this.style.visibility="hidden",E.observe(this),W.add(this))})}}function F(){const t=document.documentElement.clientWidth,i=t*.4,r=t*.9,o=Math.min(t*.8,100),s=Math.max(o,Math.min(i,r));return{tooltipWidth:s,tooltipHeight:s*(4/3)}}function nt(t){t(document).ready(function(){const i=t('<div id="pdl-tooltip-preview"></div>');t("body").append(i);const r=new IntersectionObserver((o,s)=>{for(const l of o)l.isIntersecting&&(l.target.classList.add("fade-in-visible"),s.unobserve(l.target))},{threshold:.1});t.arrive(".pdl-wrap",{existing:!0,onceOnly:!1},o=>{const s=t(o),l=20;let c=null;t(document).on("mousemove",function(u){if(!c)return;const f=F(),n=t(window).width();let d=u.clientX-f.tooltipWidth*.9,v=u.clientY-f.tooltipHeight/2;d=Math.max(l,Math.min(d,n-f.tooltipWidth-l)),v=Math.max(l,Math.min(v,t(window).height()-f.tooltipHeight-l)),i.css({left:d,top:v})}),s.on("mouseenter",".snip, .extra",function(){const u=t(this);c=this;const f=u.css("backgroundImage"),n=this.getBoundingClientRect(),d=F();i.css({"background-image":f,width:n.width,height:n.height,top:n.top+window.scrollY,left:n.left+window.scrollX,opacity:1,transform:"scale(1)",transition:"all .2s ease-out"}),u.addClass("snip-hovered"),s.addClass("pdl-wrap-hover");const v=t(window).width();let b=n.left-d.tooltipWidth-l,e=n.top+n.height/2-d.tooltipHeight/2;if(b<l){const a=n.right+l;a+d.tooltipWidth<v-l?b=a:b=(v-d.tooltipWidth)/2}b=Math.max(l,Math.min(b,v-d.tooltipWidth-l)),e=Math.max(l,Math.min(e,t(window).height()-d.tooltipHeight-l)),setTimeout(()=>{i.css({width:d.tooltipWidth,height:d.tooltipHeight,top:e+window.scrollY,left:b+window.scrollX})},10)}),s.on("mouseleave",".snip, .extra",function(){if(!c)return;const u=c.getBoundingClientRect();i.css({width:u.width,height:u.height,top:u.top+window.scrollY,left:u.left+window.scrollX,opacity:0}),t(c).removeClass("snip-hovered"),s.removeClass("pdl-wrap-hover"),c=null}),s.arrive(".snip, .extra",{existing:!0,onceOnly:!1},u=>{r.observe(u)}).leave(".snip, .extra",u=>{r.unobserve(u)})})})}function j(t,i){const r=!!t,o=!!i;return`
            <div class="sr ${o?"ds":""} ${r?"has-value":""}">
                ${r?`<div class="s1">${t||""}</div>`:""}
                ${o?`<div class="s2">${i||""}</div>`:""}
            </div>`}function B(){g(".details-product-attribute__value").each(function(t,i){const r=g(i);if(r.find(".fs").length>0)return;let o=r.html();if(o.trim().startsWith(":::")){let c="",u=[];for(o.replace(/<br\s*\/?>/gi,`
`).replace(/&lt;/g,"<").replace(/&gt;/g,">").split(`
`).forEach(n=>{if(n=n.trim(),!!n)if(n.startsWith(":::")){const d=n.substring(3).trim().split(/\s+/),v=d[0];let b=d.slice(1).join(" ");b.includes(".")&&(b=b.replace(/\./g," ").trim()),c+=`<${v}${b?` class='${b}'`:""}>`,u.push(`</${v}>`)}else if(n.startsWith("- ")){let d=n.substring(2).trim();d=d.replace(/\*\*(.*?)\*\*/g,"<b>$1</b>").replace(/\*(.*?)\*/g,"<i>$1</i>").replace(/__(.*?)__/g,"<u>$1</u>"),c+=`<li>${d}</li>`}else c+=n});u.length;)c+=u.pop();r.html(c);return}console.log("Attribute raw:",o);let s='<div class="fs">';o=o.replace(/^\s*(_-){3,}\s*$/gm,"<hr>"),o=o.replace(/\\n/g,"<br>").replace(/\s{2,}$/gm,"<br>"),o=o.replace(/\*\*(.*?)\*\*/g,"<b>$1</b>").replace(/\*(.*?)\*/g,"<i>$1</i>").replace(/__(.*?)__/g,"<u>$1</u>"),o.split("\u2666").forEach(c=>{if(!c||c.trim()==="")return;let f=c.replace(/^\<br\s*\/?\>/i,"").replace(/\<br\s*\/?\>$/i,"").trim();if(/^\s*<b>.*<\/b>\s*$/.test(f)){s+=`
                <div class="sr spec-header">
                    <div class="spec-full" style="visibility: hidden;">${f}</div>
                </div>`;return}let n=null;f.startsWith("<b>")&&f.endsWith("</b>")?n="b":f.startsWith("<i>")&&f.endsWith("</i>")&&(n="i");let d=f;if(n&&(d=f.substring(3,f.length-4)),d.includes("|")){let b=d.split("|"),e=b[0].trim(),a=b.slice(1).join("|").trim();n&&(e=`<${n}>${e}</${n}>`,a=`<${n}>${a}</${n}>`),s+=j(e,a);return}let v=d.match(/^(\d+(?:\.\d+)?[A-Za-z%]+)\s+(.+)$/);if(v){let b=v[1],e=v[2];n&&(b=`<${n}>${b}</${n}>`,e=`<${n}>${e}</${n}>`),s+=j(b,e);return}s+=j("",f)}),s+="</div>",r.html(s)})}export{nt as initSnips,st as injectProductDetailsTabs,B as initProductAttributeTables};
